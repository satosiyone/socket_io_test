<!doctype html>
<html>
  <head>
    <title>マジョリ</title>
    <style>
      body { font: 13px Helvetica, Arial; width: 50%; margin: 0 auto; }
      form { background: #000; padding: 3px; width: 80%;}
      form input { border: 0; padding: 10px; width: 60%; margin-right: .5%; }
      form button { width: 20%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <script>
        var socket = io();
        var userName = '';
        $(function () {
            //ログイン
            //ログイン画面表示
            $('#loginForm').show();
            $('#chatForm').hide();
            
            //ログイン処理
            $('#btnLogin').on('click', function(e){
                userName = $('#username').val();
                if(userName){
                    //チャット画面表示
                    $('#loginForm').hide();
                    $('#chatForm').show();
                    //ユーザ情報をサーバへ通知する
                    socket.emit('login',{
                        userID: socket.id,
                        userName: userName
                    });
                }
                e.preventDefault();
            });

            //チャット
            //メッセージを送信したとき
            $('form').submit(function(e){
                e.preventDefault(); // prevents page reloading
                socket.emit('chat message', $('#m').val());
                $('#m').val('');
                return false;
            });

            // クライアントAのemitに対して、クライアントBのonでメッセージを受け取る
            socket.on('chat message', function(msg){
                $('#messages').append($('<li>').text(msg.userName + ':' + msg.message));
            });

            //ユーザリスト表示
            socket.on('user list', function(loginUsers){
                //console.log('FS:type表示');
                //console.log('str = ' + str);
                
                console.log('FS:typeof loginUsers = ' + (typeof loginUsers) );
                var length = Object.keys(loginUsers).length;
                console.log('length = ' + length);
                console.log('[ID] = ' + socket.id); 
                //console.log('loginUsers[ID] = ' + loginUsers[socket.id]);                
            });

            //test1
            socket.on('test1', function(obj1){
                var length = Object.keys(obj1).length;
                console.log('obj1.length = ' + length); // obj1.length = 1
                for(var i in obj1){
                 console.log('obj[' + i +'] = ' + obj1[i]); // obj[hoge] = hoge
                };
            });
            //test2
            socket.on('test2', function(obj2){
                var length = Object.keys(obj2).length;
                console.log('obj2.length = ' + length); // obj2.length = 0
                for(var i in obj2){
                 console.log('obj[' + i +'] = ' + obj2[i]);
                };
            });
        });
    </script>
    </head>
    <body>
        <div>
            <!-- ログイン -->
            <form id="loginForm">
                <div>
                    <input id="username" name="username" type="text" class="form-control"
                            placeholder="ユーザ名" autocomplete="off" autofocus />
                    <button id="btnLogin">ログイン</button>
                </div>
            </form>
            <!-- チャット -->
            <ul id="messages"></ul>
            <form action="#" id="chatForm">
                <input id="m" autocomplete="off" autofocus />
                <button>Send</button>
            </form>
        </div>
        <div>
            <!-- 入室者リスト -->
            <h1>入室者リスト</h1>
                <ul id="userList"></ul>
        </div>
    </body>
</html>